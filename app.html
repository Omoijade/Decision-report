<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Decision Record — Tool</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    /* Screen */
    .print-only { display: none; }
    .task-done { opacity: 0.55; text-decoration: line-through; }

    /* Print: only the record (clean PDF) */
    @media print {
      body { background: #fff !important; }
      /* Hide everything */
      body * { visibility: hidden !important; }
      /* Show only the print block */
      .print-only, .print-only * { visibility: visible !important; }
      .print-only {
        display: block !important;
        position: absolute;
        left: 0; top: 0;
        width: 100%;
        padding: 24px;
      }
      @page { margin: 16mm; }
    }
  </style>
</head>
<body class="bg-slate-50 text-slate-900 min-h-screen">

  <!-- Top bar -->
  <header class="no-print bg-white border-b sticky top-0 z-40">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between gap-4">
      <div class="flex items-center gap-2 min-w-0">
        <a href="index.html" class="flex items-center gap-2 min-w-0">
          <div class="w-3 h-3 rounded bg-teal-600"></div>
          <div class="font-black tracking-tight truncate">Decision Record</div>
        </a>
        <span class="text-xs font-black text-slate-300">•</span>
        <div class="text-xs font-bold text-slate-500 truncate" id="top-hint">Last 10 minutes of the meeting</div>
      </div>

      <div class="flex items-center gap-2">
        <button id="btn-new" class="text-xs font-black text-slate-500 hover:text-slate-900 px-2 py-1 rounded">
          New
        </button>
        <button id="btn-export" class="text-xs font-black text-slate-500 hover:text-slate-900 px-2 py-1 rounded">
          Export JSON
        </button>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6 md:py-8">
    <!-- Guidance banner -->
    <div class="no-print bg-white border rounded-2xl p-4 md:p-5 shadow-sm">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
        <div class="space-y-1">
          <div class="text-sm font-black">Use this in the last 10 minutes of a meeting.</div>
          <div class="text-xs text-slate-600">
            Short is fine. Capture the outcome: <span class="font-bold">what decided</span>, <span class="font-bold">why</span>, <span class="font-bold">who next</span>.
          </div>
        </div>
        <div class="text-xs text-slate-500">
          Drafts stay on this device. Avoid sensitive personal data.
        </div>
      </div>
    </div>

    <div class="mt-6 grid grid-cols-1 lg:grid-cols-2 gap-6">
      <!-- Editor -->
      <section class="no-print space-y-6">
        <div class="bg-white border rounded-2xl shadow-sm p-5 md:p-6">
          <div class="text-xs font-black tracking-widest uppercase text-slate-400">Decision</div>
          <input id="inp-title" type="text"
            class="mt-3 w-full text-2xl font-black border-b-2 border-slate-100 focus:border-teal-600 outline-none pb-2"
            placeholder="Decision (one sentence)…" />

          <div class="mt-4">
            <div class="text-[11px] font-black uppercase tracking-widest text-slate-400">Reason</div>
            <textarea id="inp-reason" rows="5"
              class="mt-2 w-full bg-slate-50 border rounded-xl p-3 text-sm outline-none focus:ring-2 ring-teal-100"
              placeholder="Why now? What trade-off are we accepting? What would make us revisit? (2–4 lines)"></textarea>
          </div>

          <!-- Minimal next step always visible -->
          <div class="mt-5">
            <div class="flex items-center justify-between gap-2">
              <div class="text-[11px] font-black uppercase tracking-widest text-slate-400">Next steps</div>
              <div class="flex gap-2">
                <button id="btn-addStep"
                  class="text-[11px] font-black bg-teal-50 text-teal-800 px-3 py-1 rounded-full hover:bg-teal-100">
                  + Add
                </button>
                <button id="btn-clearSteps"
                  class="text-[11px] font-black bg-slate-100 text-slate-700 px-3 py-1 rounded-full hover:bg-slate-200">
                  Clear
                </button>
              </div>
            </div>
            <div class="mt-2 text-[11px] text-slate-500">
              Tip: start with an owner: <span class="font-bold">“Alex: …”</span>
            </div>

            <div id="task-list" class="mt-3 space-y-2"></div>
          </div>

          <!-- Optional extras -->
          <details class="mt-5 border-t pt-4">
            <summary class="cursor-pointer text-xs font-black text-slate-700">
              Optional details (stage, revisit date)
            </summary>
            <div class="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-4">
              <div>
                <label class="text-[11px] font-black uppercase tracking-widest text-slate-400">Stage</label>
                <select id="inp-stage" class="mt-2 w-full bg-slate-50 border rounded-xl p-2 text-sm font-bold">
                  <option value="DRAFT">Draft</option>
                  <option value="REVIEW">For review</option>
                  <option value="COMMITTED">Committed</option>
                </select>
                <div class="mt-2 text-[11px] text-slate-500">
                  Draft = thinking • For review = feedback/approval • Committed = we’re doing it
                </div>
              </div>
              <div>
                <label class="text-[11px] font-black uppercase tracking-widest text-slate-400">Revisit date (optional)</label>
                <input id="inp-revisit" type="date" class="mt-2 w-full bg-slate-50 border rounded-xl p-2 text-sm" />
                <div class="mt-2 text-[11px] text-slate-500">Use if you’re unsure or want to check assumptions later.</div>
              </div>
            </div>
          </details>
        </div>

        <!-- Actions -->
        <div class="bg-white border rounded-2xl shadow-sm p-5 md:p-6">
          <div class="flex flex-col sm:flex-row gap-2">
            <button id="btn-copy"
              class="flex-1 inline-flex items-center justify-center gap-2 bg-slate-900 hover:bg-black text-white font-black text-xs uppercase tracking-widest py-3 rounded-xl">
              <i data-lucide="copy" class="w-4 h-4"></i> Copy record
            </button>
            <button id="btn-print"
              class="flex-1 inline-flex items-center justify-center gap-2 bg-white border hover:border-teal-300 text-slate-800 font-black text-xs uppercase tracking-widest py-3 rounded-xl">
              <i data-lucide="printer" class="w-4 h-4"></i> Print / Save PDF
            </button>
          </div>

          <div class="mt-3 flex items-start gap-2 text-xs text-slate-600">
            <i data-lucide="folder" class="w-4 h-4 mt-0.5 text-slate-400"></i>
            <div>
              After copying or saving PDF, store it where your team can find it (e.g., shared folder or email thread).
              <span class="text-slate-400">Coming soon (paid): team archive + search.</span>
            </div>
          </div>

          <div class="mt-3 text-[11px] text-slate-500">
            This tool saves drafts on this device only. Nothing is sent anywhere unless you copy/paste or print.
          </div>
        </div>
      </section>

      <!-- Record preview -->
      <section class="space-y-4">
        <div class="bg-white border rounded-2xl shadow-sm overflow-hidden">
          <div class="px-5 py-4 border-b flex items-center justify-between gap-3">
            <div class="min-w-0">
              <div class="text-xs font-black tracking-widest uppercase text-slate-400">Decision record</div>
              <div class="text-sm font-black text-slate-800 truncate" id="out-title-mini">Untitled</div>
            </div>
            <div class="text-xs font-black text-slate-500" id="out-ref-mini"></div>
          </div>

          <div class="p-5">
            <pre id="out-record"
              class="whitespace-pre-wrap text-xs leading-relaxed font-mono bg-slate-50 border rounded-xl p-4"></pre>

            <div id="readiness" class="mt-3 text-xs font-bold flex items-center gap-2"></div>
          </div>
        </div>

        <!-- Print-only record (clean PDF) -->
        <div class="print-only">
          <pre id="print-record" class="whitespace-pre-wrap font-mono text-sm"></pre>
        </div>
      </section>
    </div>
  </main>

  <!-- Toast -->
  <div id="toast"
    class="no-print fixed bottom-6 left-1/2 -translate-x-1/2 px-5 py-2 bg-slate-900 text-white text-[11px] font-black rounded-full shadow-2xl opacity-0 transition-all pointer-events-none z-50 uppercase tracking-widest"></div>

  <script>
    const STORAGE_KEY = "decision_record_v1";

    const DEFAULT_STATE = {
      title: "",
      reason: "",
      stage: "DRAFT",
      revisit: "",
      tasks: [{ id: Date.now(), text: "", done: false }],
      refFrozen: false,
      ref: "" // e.g., "CHT-2026-01-01"
    };

    let state = { ...DEFAULT_STATE };

    function $(id) { return document.getElementById(id); }

    function save() {
      try { localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); } catch {}
    }

    function load() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return;
        const parsed = JSON.parse(raw);
        state = {
          ...DEFAULT_STATE,
          ...parsed,
          tasks: Array.isArray(parsed?.tasks) && parsed.tasks.length ? parsed.tasks : DEFAULT_STATE.tasks
        };
      } catch {}
    }

    function showToast(msg) {
      const el = $("toast");
      el.textContent = String(msg || "");
      el.style.opacity = "1";
      clearTimeout(window.__t);
      window.__t = setTimeout(() => el.style.opacity = "0", 1400);
    }

    // Stop-words to keep acronyms readable (EN + FR common)
    const STOP = new Set([
      "the","a","an","and","or","to","of","for","in","on","with","at","by","from",
      "le","la","les","un","une","des","et","ou","de","du","au","aux","pour","dans","sur","avec","par"
    ]);

    function acronymFromTitle(title) {
      const cleaned = String(title || "")
        .trim()
        .replace(/[’'"]/g, "")
        .normalize("NFD").replace(/\p{Diacritic}/gu, ""); // strip accents

      const words = cleaned
        .split(/\s+/)
        .map(w => w.replace(/[^a-zA-Z0-9-]/g, ""))
        .filter(Boolean)
        .filter(w => !STOP.has(w.toLowerCase()));

      const letters = words.map(w => w[0]).filter(Boolean).join("").toUpperCase();
      // cap to 2–6 letters so it stays usable
      if (letters.length >= 2) return letters.slice(0, 6);
      if (letters.length === 1) return letters;
      // fallback if title is weird
      return "DR";
    }

    function todayISO() {
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2, "0");
      const dd = String(d.getDate()).padStart(2, "0");
      return `${yyyy}-${mm}-${dd}`;
    }

    function freezeRefIfNeeded() {
      if (state.refFrozen) return;
      const t = String(state.title || "").trim();
      if (!t) return; // don't freeze if there's no decision
      const ref = `${acronymFromTitle(t)}-${todayISO()}`;
      state.ref = ref;
      state.refFrozen = true;
      save();
    }

    function stageLabel(code) {
      return ({ DRAFT: "Draft", REVIEW: "For review", COMMITTED: "Committed" }[code] || "Draft");
    }

    function openTasks() {
      return (state.tasks || [])
        .filter(t => (t.text || "").trim())
        .filter(t => !t.done)
        .map(t => t.text.trim());
    }

    function recordText() {
      const title = (state.title || "").trim() || "Untitled decision";
      const reason = (state.reason || "").trim();
      const stage = stageLabel(state.stage || "DRAFT");
      const revisit = (state.revisit || "").trim();
      const steps = openTasks();

      const lines = [];
      lines.push("DECISION RECORD");
      if (state.refFrozen && state.ref) lines.push(`Ref: ${state.ref}`);
      lines.push(`Decision: ${title}`);
      lines.push(`Stage: ${stage}`);
      if (revisit) lines.push(`Revisit: ${revisit}`);
      lines.push("");
      lines.push("Reason");
      lines.push(reason ? reason : "- (Add 2–4 lines. Short is fine.)");
      lines.push("");
      lines.push("Next steps (open)");
      if (steps.length) {
        steps.forEach(s => lines.push(`- ${s}`));
      } else {
        lines.push("- (Add one step with an owner, e.g., “Alex: …”)");
      }
      lines.push("");
      lines.push("File it");
      lines.push("- Paste into your follow-up message and/or save as a PDF in a shared place your team uses.");
      return lines.join("\n");
    }

    function renderPreview() {
      const title = (state.title || "").trim();
      $("out-title-mini").textContent = title || "Untitled";
      $("out-ref-mini").textContent = state.refFrozen && state.ref ? state.ref : "";
      const txt = recordText();
      $("out-record").textContent = txt;
      $("print-record").textContent = txt;

      // Readiness (non-judgmental, direct)
      const missingTitle = !title;
      const missingReason = !(state.reason || "").trim();
      const hasOwnedStep = openTasks().some(s => /^[^:]{2,24}\s*:\s*.+$/.test(s));

      const r = $("readiness");
      r.innerHTML = "";
      r.className = "mt-3 text-xs font-bold flex items-center gap-2";

      if (missingTitle) {
        r.appendChild(icon("pencil"));
        r.appendChild(text("Write the decision (one sentence)."));
        r.classList.add("text-slate-600");
      } else if (missingReason) {
        r.appendChild(icon("clipboard-list"));
        r.appendChild(text("Add 2–4 lines of reason (why now / trade-off / revisit)."));
        r.classList.add("text-slate-600");
      } else if (!hasOwnedStep) {
        r.appendChild(icon("user"));
        r.appendChild(text("Add one next step starting with an owner (e.g., “Alex: …”)."));
        r.classList.add("text-slate-600");
      } else {
        r.appendChild(icon("check"));
        r.appendChild(text("Ready to copy or save as PDF."));
        r.classList.add("text-emerald-700");
      }

      if (window.lucide) lucide.createIcons();
    }

    function icon(name) {
      const i = document.createElement("i");
      i.setAttribute("data-lucide", name);
      i.className = "w-4 h-4";
      return i;
    }
    function text(s) {
      const span = document.createElement("span");
      span.textContent = s;
      return span;
    }

    // --- Tasks UI (stable typing) ---
    function renderTaskList() {
      const wrap = $("task-list");
      wrap.innerHTML = "";

      (state.tasks || []).forEach(task => {
        const row = document.createElement("div");
        row.className = "flex items-center gap-2";

        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.checked = !!task.done;
        cb.className = "w-4 h-4 rounded accent-teal-600";
        cb.addEventListener("change", () => {
          task.done = !task.done;
          save();
          renderPreview();
          // no rerender needed
          row.classList.toggle("opacity-60", task.done);
        });

        const input = document.createElement("input");
        input.type = "text";
        input.value = task.text || "";
        input.placeholder = "Owner: action + by when…";
        input.className = "flex-1 bg-transparent border-b border-slate-100 focus:border-teal-200 outline-none text-sm py-1";
        input.addEventListener("input", (e) => {
          task.text = String(e.target.value || "");
          save();
          renderPreview(); // update record only
        });

        const del = document.createElement("button");
        del.type = "button";
        del.className = "px-2 text-slate-200 hover:text-red-500 font-black";
        del.textContent = "×";
        del.title = "Remove";
        del.addEventListener("click", () => {
          state.tasks = (state.tasks || []).filter(t => t.id !== task.id);
          if (!state.tasks.length) state.tasks = [{ id: Date.now(), text: "", done: false }];
          save();
          renderTaskList();
          renderPreview();
        });

        row.appendChild(cb);
        row.appendChild(input);
        row.appendChild(del);
        wrap.appendChild(row);

        if (task.done) row.classList.add("opacity-60");
      });
    }

    // --- Sync from inputs to state ---
    function bind() {
      $("inp-title").addEventListener("input", (e) => {
        state.title = String(e.target.value || "");
        save();
        renderPreview();
      });

      $("inp-reason").addEventListener("input", (e) => {
        state.reason = String(e.target.value || "");
        save();
        renderPreview();
      });

      $("inp-stage").addEventListener("change", (e) => {
        state.stage = String(e.target.value || "DRAFT");
        save();
        renderPreview();
      });

      $("inp-revisit").addEventListener("change", (e) => {
        state.revisit = String(e.target.value || "");
        save();
        renderPreview();
      });

      $("btn-addStep").addEventListener("click", () => {
        state.tasks.push({ id: Date.now() + Math.floor(Math.random()*1000), text: "", done: false });
        save();
        renderTaskList();
        // focus the last input for low effort
        setTimeout(() => {
          const inputs = $("task-list").querySelectorAll("input[type='text']");
          inputs[inputs.length - 1]?.focus();
        }, 0);
      });

      $("btn-clearSteps").addEventListener("click", () => {
        state.tasks = [{ id: Date.now(), text: "", done: false }];
        save();
        renderTaskList();
        renderPreview();
        showToast("Steps cleared.");
      });

      $("btn-new").addEventListener("click", () => {
        state = { ...DEFAULT_STATE, tasks: [{ id: Date.now(), text: "", done: false }] };
        try { localStorage.removeItem(STORAGE_KEY); } catch {}
        syncUI();
        showToast("New draft.");
      });

      $("btn-copy").addEventListener("click", async () => {
        freezeRefIfNeeded();
        renderPreview();
        const text = recordText();
        try {
          if (navigator.clipboard?.writeText) {
            await navigator.clipboard.writeText(text);
            showToast("Copied.");
            return;
          }
        } catch {}
        // fallback
        const ta = document.createElement("textarea");
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        try { document.execCommand("copy"); showToast("Copied."); }
        catch { showToast("Select and copy."); }
        ta.remove();
      });

      $("btn-print").addEventListener("click", () => {
        freezeRefIfNeeded();
        renderPreview();
        window.print();
      });

      $("btn-export").addEventListener("click", () => {
        freezeRefIfNeeded();
        renderPreview();
        try {
          const safeTitle = (state.title || "untitled").toLowerCase().trim().replace(/[^a-z0-9]+/g, "-").replace(/(^-|-$)/g, "");
          const filename = `decision-record-${(state.ref || safeTitle || "untitled")}.json`;
          const blob = new Blob([JSON.stringify(state, null, 2)], { type: "application/json" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = filename;
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(url);
          showToast("Exported.");
        } catch {
          showToast("Export failed.");
        }
      });
    }

    function syncUI() {
      $("inp-title").value = state.title || "";
      $("inp-reason").value = state.reason || "";
      $("inp-stage").value = state.stage || "DRAFT";
      $("inp-revisit").value = state.revisit || "";
      renderTaskList();
      renderPreview();
      if (window.lucide) lucide.createIcons();
    }

    window.addEventListener("load", () => {
      load();
      bind();
      syncUI();
    });
  </script>
</body>
</html>
